{"ast":null,"code":"import _classCallCheck from \"@babel/runtime/helpers/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/createClass\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport { RNSharedElementContent } from \"./RNSharedElementContent.web\";\nimport { RNSharedElementStyle } from \"./RNSharedElementStyle.web\";\nimport { Rect } from \"./Rect.web\";\nexport var RNSharedElementNode = function () {\n  function RNSharedElementNode(domNode, isParent, ancestorDomNode) {\n    _classCallCheck(this, RNSharedElementNode);\n\n    this.hideRefCount = 0;\n    this.hideOpacity = null;\n    this.refCount = 1;\n    this.styleCache = null;\n    this.styleCallbacks = null;\n    this.contentCache = null;\n    this.contentCallbacks = null;\n    this.domNode = domNode;\n    this.isParent = isParent;\n    this.ancestorDomNode = ancestorDomNode;\n  }\n\n  _createClass(RNSharedElementNode, [{\n    key: \"addRef\",\n    value: function addRef() {\n      return ++this.refCount;\n    }\n  }, {\n    key: \"releaseRef\",\n    value: function releaseRef() {\n      return --this.refCount;\n    }\n  }, {\n    key: \"addHideRef\",\n    value: function addHideRef() {\n      this.hideRefCount++;\n\n      if (this.hideRefCount === 1) {\n        var element = this.resolvedElement;\n        this.hideOpacity = element.style.opacity;\n        element.style.opacity = \"0\";\n      }\n    }\n  }, {\n    key: \"releaseHideRef\",\n    value: function releaseHideRef() {\n      this.hideRefCount--;\n\n      if (this.hideRefCount === 0) {\n        var element = this.resolvedElement;\n        element.style.opacity = this.hideOpacity;\n      }\n    }\n  }, {\n    key: \"resolvedElement\",\n    get: function get() {\n      var element = this.domNode;\n\n      if (this.isParent) {\n        if (element.childNodes.length === 1) {\n          element = element.childNodes[0];\n        } else if (element.childNodes.length <= 0) {\n          console.log(\"Child for parent doesnt exist\");\n          return null;\n        }\n      }\n\n      var _element = element,\n          childNodes = _element.childNodes;\n\n      if (childNodes.length === 2) {\n        for (var i = 0; i < 2; i++) {\n          var childNode = childNodes[i];\n\n          if (childNode.tagName === \"IMG\") {\n            element = childNodes[i ? 0 : i + 1];\n            break;\n          }\n        }\n      }\n\n      return element;\n    }\n  }, {\n    key: \"resolvedAncestor\",\n    get: function get() {\n      return this.ancestorDomNode;\n    }\n  }, {\n    key: \"requestStyle\",\n    value: function requestStyle() {\n      var _this = this;\n\n      if (this.styleCache) {\n        return Promise.resolve(this.styleCache);\n      }\n\n      return new Promise(function (resolve) {\n        _this.styleCallbacks = _this.styleCallbacks || [];\n\n        _this.styleCallbacks.push(resolve);\n\n        if (!_this.fetchInitialStyle()) {\n          console.debug(\"Failed to fetch style\");\n        }\n      });\n    }\n  }, {\n    key: \"fetchInitialStyle\",\n    value: function fetchInitialStyle() {\n      var element = this.resolvedElement;\n      var ancestor = this.resolvedAncestor;\n      if (!element || !ancestor) return false;\n      if (!this.styleCallbacks) return true;\n      var rect = element.getBoundingClientRect();\n      var ancestorRect = ancestor.getBoundingClientRect();\n      var translateX = ancestorRect.x;\n      var translateY = ancestorRect.y;\n      var layout = new Rect({\n        x: rect.x - translateX,\n        y: rect.y - translateY,\n        width: rect.width,\n        height: rect.height\n      });\n      var style = new RNSharedElementStyle(layout, window.getComputedStyle(element, null));\n      this.styleCache = style;\n      var callbacks = this.styleCallbacks;\n      this.styleCallbacks = null;\n      callbacks.forEach(function (callback) {\n        return callback(style);\n      });\n      return true;\n    }\n  }, {\n    key: \"requestContent\",\n    value: function requestContent() {\n      var _this2 = this;\n\n      return _regeneratorRuntime.async(function requestContent$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              if (!this.contentCache) {\n                _context.next = 2;\n                break;\n              }\n\n              return _context.abrupt(\"return\", this.contentCache);\n\n            case 2:\n              return _context.abrupt(\"return\", new Promise(function (resolve) {\n                if (_this2.contentCallbacks) return;\n                _this2.contentCallbacks = _this2.contentCallbacks || [];\n\n                _this2.contentCallbacks.push(resolve);\n\n                _this2.fetchInitialContent();\n              }));\n\n            case 3:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, null, this, null, Promise);\n    }\n  }, {\n    key: \"fetchInitialContent\",\n    value: function fetchInitialContent() {\n      var element, size, content, callbacks;\n      return _regeneratorRuntime.async(function fetchInitialContent$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              element = this.resolvedElement;\n\n              if (element) {\n                _context2.next = 3;\n                break;\n              }\n\n              return _context2.abrupt(\"return\", false);\n\n            case 3:\n              if (this.contentCallbacks) {\n                _context2.next = 5;\n                break;\n              }\n\n              return _context2.abrupt(\"return\", true);\n\n            case 5:\n              _context2.next = 7;\n              return _regeneratorRuntime.awrap(RNSharedElementContent.getSize(element));\n\n            case 7:\n              size = _context2.sent;\n\n              if (size) {\n                _context2.next = 10;\n                break;\n              }\n\n              return _context2.abrupt(\"return\", false);\n\n            case 10:\n              content = new RNSharedElementContent(element, size);\n              this.contentCache = content;\n              callbacks = this.contentCallbacks;\n              this.contentCallbacks = null;\n              callbacks.forEach(function (callback) {\n                return callback(content);\n              });\n              return _context2.abrupt(\"return\", true);\n\n            case 16:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, null, this, null, Promise);\n    }\n  }]);\n\n  return RNSharedElementNode;\n}();","map":{"version":3,"sources":["../../src/web/RNSharedElementNode.web.ts"],"names":[],"mappings":"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","sourcesContent":["import { RNSharedElementContent } from \"./RNSharedElementContent.web\";\nimport { RNSharedElementStyle } from \"./RNSharedElementStyle.web\";\nimport { Rect } from \"./Rect.web\";\nimport { IHTMLElement } from \"./types\";\n\nexport type RNSharedElementNodeStyleCallback = (\n  value: RNSharedElementStyle\n) => void;\nexport type RNSharedElementNodeContentCallback = (\n  value: RNSharedElementContent\n) => void;\n\nexport class RNSharedElementNode {\n  public readonly domNode: IHTMLElement;\n  public readonly ancestorDomNode: IHTMLElement;\n  public readonly isParent: boolean;\n  private hideRefCount: number = 0;\n  private hideOpacity: string | null = null;\n  private refCount: number = 1;\n  private styleCache: RNSharedElementStyle | null = null;\n  private styleCallbacks: RNSharedElementNodeStyleCallback[] | null = null;\n  private contentCache: RNSharedElementContent | null = null;\n  private contentCallbacks: RNSharedElementNodeContentCallback[] | null = null;\n\n  constructor(\n    domNode: IHTMLElement,\n    isParent: boolean,\n    ancestorDomNode: IHTMLElement\n  ) {\n    this.domNode = domNode;\n    this.isParent = isParent;\n    this.ancestorDomNode = ancestorDomNode;\n  }\n\n  addRef() {\n    return ++this.refCount;\n  }\n\n  releaseRef() {\n    return --this.refCount;\n  }\n\n  addHideRef() {\n    this.hideRefCount++;\n    if (this.hideRefCount === 1) {\n      const element = this.resolvedElement;\n      this.hideOpacity = element!.style.opacity;\n      element!.style.opacity = \"0\";\n    }\n  }\n\n  releaseHideRef() {\n    this.hideRefCount--;\n    if (this.hideRefCount === 0) {\n      const element = this.resolvedElement;\n      // @ts-ignore\n      element!.style.opacity = this.hideOpacity;\n    }\n  }\n\n  get resolvedElement(): IHTMLElement | null {\n    let element: IHTMLElement = this.domNode;\n\n    // If this node is a parent, look for the first child\n    if (this.isParent) {\n      if (element.childNodes.length === 1) {\n        // @ts-ignore\n        element = element.childNodes[0];\n      } else if (element.childNodes.length <= 0) {\n        console.log(\"Child for parent doesnt exist\");\n        return null;\n      }\n    }\n\n    // Get background-image node\n    const { childNodes } = element;\n    if (childNodes.length === 2) {\n      for (let i = 0; i < 2; i++) {\n        // @ts-ignore\n        const childNode: IHTMLElement = childNodes[i];\n        if (childNode.tagName === \"IMG\") {\n          // @ts-ignore\n          element = childNodes[i ? 0 : i + 1];\n          break;\n        }\n      }\n    }\n\n    return element;\n  }\n\n  get resolvedAncestor(): IHTMLElement | null {\n    return this.ancestorDomNode;\n  }\n\n  requestStyle(): Promise<RNSharedElementStyle> {\n    if (this.styleCache) {\n      return Promise.resolve(this.styleCache);\n    }\n    return new Promise(resolve => {\n      this.styleCallbacks = this.styleCallbacks || [];\n      this.styleCallbacks.push(resolve);\n      if (!this.fetchInitialStyle()) {\n        console.debug(\"Failed to fetch style\");\n        //startRetryLoop();\n      }\n    });\n  }\n\n  private fetchInitialStyle(): boolean {\n    const element = this.resolvedElement;\n    const ancestor = this.resolvedAncestor;\n    if (!element || !ancestor) return false;\n    if (!this.styleCallbacks) return true;\n\n    // Fetch layout\n    const rect = element.getBoundingClientRect();\n    // const ancestorTransform = ancestor.style.transform;\n    const ancestorRect = ancestor.getBoundingClientRect();\n    // console.log(\"ancestorTransform: \", ancestor.style, ancestorRect);\n    const translateX = ancestorRect.x; // TODO\n    const translateY = ancestorRect.y; // TODO\n    const layout = new Rect({\n      x: rect.x - translateX,\n      y: rect.y - translateY,\n      width: rect.width,\n      height: rect.height\n    });\n\n    // Create style\n    const style = new RNSharedElementStyle(\n      layout,\n      // @ts-ignore\n      window.getComputedStyle(element, null)\n    );\n\n    // console.debug(\"Style fetched: \", style);\n\n    // Update cache\n    this.styleCache = style;\n\n    // Notify callbacks\n    const callbacks = this.styleCallbacks;\n    this.styleCallbacks = null;\n    callbacks.forEach(callback => callback(style));\n    return true;\n  }\n\n  async requestContent(): Promise<RNSharedElementContent> {\n    if (this.contentCache) return this.contentCache;\n\n    return new Promise(resolve => {\n      if (this.contentCallbacks) return;\n      this.contentCallbacks = this.contentCallbacks || [];\n      this.contentCallbacks.push(resolve);\n      this.fetchInitialContent();\n      // TODO RETRY IN CASE OF FAILURE?\n    });\n  }\n\n  private async fetchInitialContent(): Promise<boolean> {\n    const element = this.resolvedElement;\n    if (!element) return false;\n    if (!this.contentCallbacks) return true;\n\n    // Fetch content size\n    const size = await RNSharedElementContent.getSize(element);\n    if (!size) {\n      return false;\n    }\n\n    // Create content\n    const content = new RNSharedElementContent(element, size);\n\n    // console.debug(\"Content fetched: \", content);\n\n    // Update cache\n    this.contentCache = content;\n\n    // Notify callbacks\n    const callbacks = this.contentCallbacks;\n    this.contentCallbacks = null;\n    callbacks.forEach(callback => callback(content));\n    return true;\n  }\n}\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}